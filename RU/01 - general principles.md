# Общие принципы

Есть ряд привычек/правил, которые, на мой взгляд, естественным образом улучшают качество кода. Как если не ходить под домами зимой, то вероятность того, что вам на голову упадет снег уменьшается или исчезает совсем. Так правильные привычки в разработке уменьшают потенциальное количество багов и увеличивают вашу ежедневную эффективность и легкость поддержки написанного решения.

Кстати вот хорошая и короткая статья, суть которой очень совпадает с моими собственными наблюдениями - [Как важно писать хороший код](https://m.habr.com/ru/post/206294/) - четко ! (Must read).

## Читабельность

*"Code must be written for people to read and only incidentally for machines to execute" (c) Abelson & Sussman, "Structure and Interpretation of Computer Programs"*

Читабельность очень важное свойство кода. Читабельность экономит время и улучшает взаимопонимание. Ряд принципов ниже прямо или косвенно улучшают читабельность. Идеал читабельного кода - это когда документация к нему не нужна, достаточно пройтись глазами по коду и понять что он делает (идеал объективно сложно-достижимый, но нужно к нему стремиться). Это подразумевает понятно название переменных, понятное название методов, правильное структурирование кода, чтобы каждый фрагмент занимался своим понятным делом, разбиение кода на небольшие блоки, которые умещаются в голову за раз (классы, методы ...) и т.п. В читаемом коде легче исправлять ошибки, его проще поддерживать, в нем проще разбираться вашим коллегам - все это экономит время и есть проявлением уважения к другим людям.

### Индентация

Соблюдение индентации в коде обязательно. Неправильная индентация очень сильно ухудшает читабельность и может являться источником багов т.к. можно ошибочно определить куда относится та или иная операция.

Правильная индентация увеличивает скорость восприятия - это обосновано тем, как работает наш мозг, который пытается искать информацию в предсказуемых для себя местах. Это очень хорошо показано вот в этом видео (смотреть обязательно) - [Kevlin Henney - Seven Ineffective Coding Habits of Many Programmers](https://www.youtube.com/watch?v=ZsHMHukIlJY) (в основном в диапазоне 10:30 ~ 23:00, но рекомендую посмотреть все видео)

### Осмысленные наименования переменных и методов 

Есть "полу"-шутка, что 2 самых больших проблемы в разработке это инвалидация кеша и наименование переменных. Именование переменных не просто так поставили в ряд с одной из очень сложных проблем информационных систем, Хорошее название придумать сложно - это нормально - не сдавайтесь, результат окупится.

Код должен очевидным настолько насколько это возможно, причем без комментариев. Для этого используйте осмысленные названия методов и переменных. Длинные названия - это в целом нормально, если они точно объясняют происходящее.  Стоит потратить время, чтобы выбрать правильно подходящее слово на английском для названия переменной или метода. Исключением могут быть итераторы, которые используются в пределах нескольких следующих строк и контекст которых очевиден (напр. `<i>` если мы говорим про abap).

В идеале код должен читаться, как книга. Причем без текстовых комментариев. Кстати это интересное и непростое упражнение - писать код без комментриев, так оставалось понятно что он делает. Это подразумевает использование правильных терминов из доменной области в названиях переменных и методов, избегание широких терминов типа `get`, `line`.  Комментарии не абсолютное зло - иногда они уместны, когда логика (бизнес логика или специфика алгоритма) не очевидна, но в 90% случаев их можно избежать.

### Длина методов и функций

Старайтесь, чтобы функции/методы были не длиннее 60-80 строк. Это делает их более читаемыми, структурированными и сфокусированными на одной задаче. А также это легче тестировать, отлаживать. В идеале метод должен делать одну вещь, одно действие. Его суть должна легко помещаться к голову. (NASA style, < 60 lines of code is a good example).

### Уровень вложенности

Не используйте более 3 уровней вложенности ветвлений (и даже это должно быть исключением) - такой код всегда можно оптимизировать или разделить (см. "метод должен делать одну вещь" выше). В целом, думайте как уменьшить количество ветвлений - они плохо читаются. Полезно себе задать себе вопрос, как можно написать этот код совсем без ветвлений! На пути к такой цели, могут обнаружиться интересные архитектурные открытия. Например понимание, что данный конкретный if должен быть в другом месте, на более высоком уровне, где “принимается решение” о направлении работы программы.

### Документация

Пишите документацию к вашему коду. Критерий качества документации в первую очередь, чтобы вы сами могли вернуться к коду через 3 месяца и быстро восстановить знания о том, что и как работает. "Когда я писал этот код, только я и Бог знали как он работает. Теперь - только Бог. (с)"

Задайте себе вопрос сколько уйдет у вас времени на краткие заметки о реализованном решении прямо сейчас, когда в голове есть все детали решения. И колько у вас уходит времени на том, чтобы разобраться в незнакомом коде (да, через пару месяц ваш код станет вам незнакомым). И выбор станет очевиден.

## Практики

- Отделение выборки данных, обработки и отображения (общий принцип подхода model-view-controller). Обработка данных не должна знать про отображение и наоборот
    - Для обработки данных нужно писать тесты (см ниже). Если в коде есть select, то написать тест толком нельзя. Поэтому выборка данных должна быть в отдельном методе или интерфейсе (чтобы его можно было подменить). 
    - Отображение данных может быть разное. Например можно вывести данные в ALV или отправить по почте в виде PDF файла. А данные одинаковые, только представление разное. Также представление часто означает какое-то взаимодействие с пользователем. 
    - Поэтому обработка данных не должна знать про отображение, а отображение - про обработку. Каждый кусок кода должен заниматься только своей функцией, тогда его легко читать, тестировать и отлаживать.
- Какие данные и как будут ходить между объектами/вызовами и какая сущность каждого класса - именно с этого начинайте продумывать архитектуру. Обычно данные более однозначны, чем внутреннее устройство классов. Правильно продумав обмен данными можно будет легче рефакторить код классов и избежать переписывания юнит тестов, при изменении архитектуры кода. Правильно разделив сущности код делается более универсальным и переиспользуемым.
- Пишите юнит тесты (подробнее в отдельном разделе). Это не “желательно”, это обязательно. Юнит тесты: облегчают поддержку кода, облегчают сам процесс написания программы, облегчают разворачивание программы у клиента, естественным образом заставляют лучше продумывать архитектуру решения (посколько комок спагетти-кода обложить юнит тестами невозможно).
- Стремитесь использовать Функциональное программирование - если очень кратко функциональный подход состоит в том, чтобы писать функции/методы без состояния и side-effects. Т.е. Такой код, который явно преобразовывает входящие данные в исходящие, без обращений к внешним сущностям. Такие функции легко отлаживаются, легко тестируются, менее подвержены багам. Вызывающий их код легче читается (т.к. Не нужно думать про побочные эффекты). На практике старайтесь где возможно пользоваться статическими методами, без внешних переменных. Старайтесь избегать низкоуровневых методов, которые меняют атрибуты класса - выносите изменения в верхнеуровневые “контроллеро-подобные” методы.
- Глобальные переменные - это зло, не используйте их. Совсем. Никогда. Кстати к глобальным переменным относятся и атрибуты классов т.к. они выше "контекста" исполнения метода. Само собой класс должен гдето хранить свое состояние, но часто стоит задуматься необходим ли данный атрибут на самом деле и нужен ли доступ к нему конкретному методу (см. функциональное программирование выше). Отсутствие глобальных переменных = отсутствие багов (обычно сложных) связанных с ними.

- Использование исключений. Исключения позволяют унифицировать обработку ошибок. Catch можно расположить на самом верхнем уровне выполнения программы - исключения будут “выныривать” с любой глубины и, например, выводится пользователю. Можно создавать разные классы исключений для разных категорий ошибок (если это не создает сложности в их обработке - пользуйтесь наследованием).

- Избегайте неопределенных состояний программы. Код должен защищать сам себя от кривого ввода, в том числе от неправильного использования другим кодом. Используйте проверки и assert’ы в начале методов - не доверяйте вызывающему коду, даже если написали его сами - через месяц вы забудете об ограничениях и сделаете ошибку, проверки в начале должны ее словить. Гораздо лучше свалившаяся в дамп программа, чем программа, продолжившая выполнение с незапланированным состоянием. Избегайте этого всеми силами. Хороший разработчик продумывает не только основной ход программы, но и крайние ситуации и как программа должна реагировать на них.
    - Еще лучше чем дамп, будет корректный вывод ошибки пользователю. Однако стоит различать пользовательские ошибки (появившиеся в результате кривых данных, введенных пользователем) и программистские (появившиеся в результате неправильного использования метода, напр. ожидается что параметр не пустой). Первые должны быть подробные, давать информацию о том, что именно произошло и что делать (см юзабилити ниже). Вторые могут быть проще.

## Прочее

### Не зашивайте бизнес константы в код

Я серьезно, не зашивайте бизнес константы в код!!! Параметры к программе, таблица настройки, динамическое определение из стандартных настроек системы (лучше всего), но не хардкодьте бизнес значения, нетипичные для системы глобально. А еще, Боже упаси, хардкодить АПИ ключи или пароли к чему то.

### Уважайте подходы оформления

... принятые на конкретном проекте. Старайтесь придерживаться единого стиля. Это улучшает читабельность, а следовательно экономит ваше время и время ваших коллег при восприятии информации.

- если неудобно, то скорее всего плохо и нужно переписать - это сигнал/эвристика, что что-то сделано не так.
- Для отслеживания изменений в коде мы используем Git и abapGit
    - Что такое GIT, GITHUB и BITBUCKET? / Просто и понятно
    - Git Fu - правила хорошего использования Git
    - Using git and github on an sap abap system
